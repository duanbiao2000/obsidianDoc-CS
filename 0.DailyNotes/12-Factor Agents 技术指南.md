# 12-Factor Agents 技术指南

## 核心理念与洞察

### 核心原则 #card-reverse
AI Agent的本质是 **软件工程问题**，而非AI研究问题。应将其视为 `Software + LLM` 的组合。

### 关键洞察
AI Agent的核心技术挑战是什么?::控制流所有权、状态管理、上下文工程和可靠性保证。
生产环境中成功的AI Agent通常基于什么概念构建?::模块化概念，而非单一的、庞大的“智能”实体。
LLM最可靠、最有价值的核心能力是什么?::将自然语言转换为**结构化数据**（如JSON）。
“工具使用”（Tool Use）的正确观点是什么?::它不是神秘的交互，而是 **JSON + 代码** 的确定性过程。
为什么说Agent必须是无状态的（Stateless）?::为了实现水平扩展、随时暂停/恢复以及可重放调试。
无状态Agent如何处理状态?::将所有状态（执行状态和业务状态）**外部化**到数据库或消息体中。

### 避坑指南
在Agent开发中，为什么不应完全依赖框架来自动管理上下文?::因为在复杂的调用栈（如七层调用栈）中会难以定位和调试问题。
为什么不应让LLM自由探索复杂流程?::因为在长流程中可靠性极低，应使用微Agent和确定性的DAG（有向无环图）进行编排。
为什么不能忽略Token密度?::经验表明，每节省100个Token，质量可能提升5%，因为更少的Token能传递更清晰、无歧义的信息。

## 12要素详解 (精选)

### Factor 1: 结构化输出
LLM最核心的价值是==将自然语言转换为结构化数据==。

### Factor 2: 提示词所有权
为了让Agent质量超越80%的阈值，必须对Prompt做什么?::手工优化每一个Token，关注**密度**和**清晰度**。
在构建上下文时，应如何组织信息以提高清晰度?::使用XML或Markdown等结构化标记来分隔不同的语义块（如SYSTEM, CONTEXT, OUTPUT FORMAT）。

### Factor 4: 工具调用即代码
工具调用的反模式是什么?::让LLM“自由探索”环境，例如执行一个模糊的指令 `llm.execute("Fix the deployment")`。
工具调用的正确模式是什么?::LLM输出结构化的指令（JSON），然后由代码（如switch语句）来确定性地执行。

### Factor 6: 错误处理
处理Agent错误时的正确模式是什么?::**摘要**错误信息，提取关键点（如API 404），并将其结构化后反馈给LLM，而不是直接堆叠错误栈。

### Factor 8: 控制流所有权
### 掌控控制流 #card
**问题：** 传统Agent循环（Prompt → Tool → Append → Repeat）在长流程中为何会失效？
**答案：** 因为会导致上下文窗口爆炸和状态丢失，从而使LLM的决策变得不可靠。

如何解决传统Agent循环的问题以掌控控制流?::将上下文窗口**序列化**存入数据库，并通过外部触发（如API调用）来恢复执行，手动管理迭代、中断和重试。

### Factor 9: 人机协作
如何设计高效的人机协作触发机制?::让LLM通过输出预定义的**自然语言Token**（如 "need_human_approval"）来决定何时需要转接人工。

### Factor 10: 微Agent架构
### 微Agent（Micro-Agents） #card-reverse
一种将大型复杂工作流拆分为多个小而专注的Agent的架构模式。每个微Agent只负责单一任务，通常包含不超过10个步骤。

### Factor 11: 无状态
Agent本身不存储状态，所有状态都应{外部化}（例如存入Redis或PostgreSQL）。

## 架构与实践

### 状态管理
Agent的状态通常分为哪两种?::**执行状态**（如当前步骤、重试次数）和**业务状态**（如消息历史、用户数据）。
Agent的暂停/恢复机制是如何实现的?::通过将当前状态（包括上下文窗口）**序列化**到外部存储（如数据库）中，并在需要时加载回来以继续执行。

### 架构设计原则
- **无状态Agent**: 状态{外部化}管理。
- **确定性DAG**: 大部分流程应保持{确定性}，仅在关键决策点嵌入Agent。
- **微Agent模式**: {小而专注}的Agent组合。
- **人类协作**: 设计自然的{人机交互点}。

### 开发流程清单
为Agent设计REST API接口的目的是什么?::为了支持从外部控制Agent的生命周期，例如通过 `POST /agent/{id}/resume` 来恢复一个暂停的Agent。
在实现控制流时，除了主循环外，还需要重点实现哪些功能?::错误处理和暂停/恢复功能。