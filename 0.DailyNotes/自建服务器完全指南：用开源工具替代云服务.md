# 自建服务器完全指南：用开源工具替代云服务

## 🎯 核心理念

用简单的开源工具（Linux + Docker + Git）替代昂贵的云服务，实现：
- **零停机部署**
- **持续交付** 
- **HTTPS 支持**
- **成本极低**（仅需域名费用）

## 🖥️ 硬件准备

### **基础设备**
- 任何旧电脑（作者使用2017年MacBook Pro）
- 安装 Linux 系统（推荐 NixOS）

### **NixOS 安装**
```bash
# 创建启动U盘
dd if=nixos.iso of=/dev/sdX bs=4M

# 安装配置（declarative配置）
{
  networking.interfaces.enp0s3.ipv4.addresses = [{
    address = "192.168.1.100";
    prefixLength = 24;
  }];
  
  services.openssh.enable = true;
  networking.firewall.allowedTCPPorts = [ 80 443 ];
}
```

## 🐳 Docker 部署

### **两阶段 Dockerfile**
```dockerfile
# 构建阶段
FROM gradle:7-jdk11 AS build
COPY . /app
WORKDIR /app
RUN gradle build

# 运行阶段
FROM openjdk:11-jre-slim
COPY --from=build /app/build/libs/*.jar app.jar
CMD ["java", "-jar", "app.jar"]
```

### **Docker Compose 配置**
```yaml
version: '3.8'
services:
  # 主应用服务
  app:
    build: 
      context: .
      dockerfile: Dockerfile
    networks:
      - app-network
  
  # 反向代理（自动HTTPS）
  caddy:
    image: caddy:2
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
    networks:
      - app-network
  
  # 开源分析工具
  plausible:
    image: plausible/analytics:latest
    networks:
      - app-network

networks:
  app-network:

volumes:
  caddy_data:
```

## 🔧 核心组件

### **Caddy 配置**（自动HTTPS）
```caddyfile
example.com {
    reverse_proxy app:8080
}

analytics.example.com {
    reverse_proxy plausible:8000
}
```

### **数据库选择**
- **SQLite**: 适合单机应用
- **PostgreSQL**: 适合需要扩展的场景

## 🚀 零停机部署

### **部署脚本**
```bash
#!/bin/bash
# deploy.sh

# 拉取最新代码
git pull origin main

# 构建镜像
docker-compose build

# 扩展到2个实例
docker-compose up -d --scale app=2

# 等待新实例启动
sleep 30

# 移除旧实例
docker-compose up -d --scale app=1

# 重载Caddy配置
docker-compose exec caddy caddy reload
```

### **自动部署脚本**
```bash
#!/bin/bash
# deploy-if-changed.sh

# 检查是否有更新
git fetch origin
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/main)

if [ $LOCAL != $REMOTE ]; then
    # 有更新，执行部署
    git pull origin main
    ./deploy.sh
fi
```

### **Cron 任务**
```bash
# 每分钟检查更新
* * * * * /home/user/automation/deploy-if-changed.sh >> /var/log/deploy.log 2>&1
```

## 🛡️ 安全配置

### **防火墙设置**
```nix
# NixOS 防火墙配置
networking.firewall = {
  enable = true;
  allowedTCPPorts = [ 22 80 443 ];  # SSH, HTTP, HTTPS
};
```

### **SSH 密钥配置**
```bash
# 生成SSH密钥
ssh-keygen -t ed25519 -C "your_email@example.com"

# 添加到GitHub
cat ~/.ssh/id_ed25519.pub
```

## 📊 监控与日志

### **日志查看**
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务
docker-compose logs app

# 使用标准工具分析
docker-compose logs | grep "ERROR" | jq '.'
```

## 🔄 扩展方案

### **不同规模的解决方案**
1. **单容器**: 直接使用 Docker CLI
2. **单机多容器**: 使用 Docker Compose
3. **多机部署**: 使用 Docker Swarm
4. **复杂编排**: 使用 Kubernetes

### **高可用方案**
```bash
# 多节点 Docker Swarm
docker swarm init
docker node ls

# 跨节点部署
docker service create --replicas 3 myapp
```

## 💰 成本对比

| 方案 | 年成本 | 特点 |
|------|--------|------|
| AWS基础配置 | $116,000 | 企业级，复杂 |
| 自建方案 | $10-50 | 简单，可控 |
| 云厂商入门 | $500-2000 | 中等复杂度 |

## 🎯 最佳实践

### **两个核心原则**
1. **避免过早优化**
2. **避免不必要的抽象**

### **适用场景**
✅ 适合：
- 个人项目
- 小型企业网站
- 学习环境
- 对成本敏感的项目

❌ 不适合：
- 需要全球低延迟
- 突发大规模流量
- 复杂的企业级需求

## 🛠️ 推荐技术栈

### **核心工具**
- **操作系统**: NixOS (可重现配置)
- **容器**: Docker + Docker Compose
- **反向代理**: Caddy (自动HTTPS)
- **版本控制**: Git
- **监控**: 内置日志 + 标准CLI工具

### **可选增强**
- **虚拟化**: KVM/QEMU
- **存储**: NAS + RAID
- **数据库**: PostgreSQL 集群
- **负载均衡**: HAProxy

## 💡 关键优势

1. **完全控制**: 不受云厂商限制
2. **成本极低**: 仅需硬件和域名费用
3. **简单透明**: 没有黑盒操作
4. **可重现**: 配置文件定义一切
5. **灵活扩展**: 可根据需求逐步升级

这种方案特别适合开发者学习系统架构，以及构建成本敏感的个人或小团队项目。


---

